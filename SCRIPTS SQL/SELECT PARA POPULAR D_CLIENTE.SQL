SELECT
    CASE 
        WHEN STG_DB_CLI_FISICA.NR_CLIENTE   IS NOT NULL THEN 'Pessoa Física'
        WHEN STG_DB_CLI_JURIDICA.NR_CLIENTE IS NOT NULL THEN 'Pessoa Jurídica'
    END AS DS_TIPO_CLIENTE,

    CAST(STG_DB_CLIENTE.NR_CLIENTE AS SMALLINT) AS NR_CLIENTE,
    STG_DB_CLIENTE.NM_CLIENTE,
    STG_DB_CLIENTE.ST_CLIENTE,
    CAST(STG_DB_CLIENTE.QT_ESTRELAS AS TINYINT) AS QT_ESTRELAS,
    STG_DB_CLIENTE.VL_MEDIO_COMPRA,
    STG_DB_CLIENTE.DS_EMAIL,

    CASE 
        WHEN STG_DB_CLIENTE.ST_CLIENTE = 'A' THEN 'Ativo'
        WHEN STG_DB_CLIENTE.ST_CLIENTE = 'I' THEN 'Inativo'
        ELSE 'DESCONHECIDO' 
    END AS DS_ST_CLIENTE,

    STG_DB_CLI_FISICA.FL_SEXO_BIOLOGICO,
    STG_DB_CLIENTE.NR_TELEFONE,

    CAST(ISNULL(
        dbo.NumbersOnly(STG_DB_CLI_FISICA.NR_CPF), 
        dbo.NumbersOnly(STG_DB_CLI_JURIDICA.NR_CNPJ)
    ) AS BIGINT) AS NR_CPF_CNPJ_NUM,

    CAST(ISNULL(
        STG_DB_CLI_FISICA.NR_CPF, 
        STG_DB_CLI_JURIDICA.NR_CNPJ
    ) AS VARCHAR(20)) AS NR_CPF_CNPJ,

    CAST(STG_DB_CLI_FISICA.DT_NASCIMENTO AS DATE) AS DT_NASCIMENTO,
    CAST(dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) AS TINYINT) AS NR_IDADE,

    CAST(CASE
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 0 AND 10  THEN '00 a 10 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 11 AND 20 THEN '11 a 20 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 21 AND 30 THEN '21 a 30 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 31 AND 40 THEN '31 a 40 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 41 AND 50 THEN '41 a 50 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 51 AND 60 THEN '51 a 60 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) BETWEEN 61 AND 70 THEN '61 a 70 anos'
        WHEN dbo.fn_GetAge(STG_DB_CLI_FISICA.DT_NASCIMENTO, GETDATE()) > 70              THEN 'Acima de 70 anos'
        WHEN STG_DB_CLI_JURIDICA.NR_CLIENTE IS NOT NULL THEN 'Pessoa Jurídica'
		ELSE 'VERIFICAR'
    END AS VARCHAR(20)) AS DS_FAIXA_ETARIA,

    CASE 
        WHEN STG_DB_CLI_JURIDICA.NR_CLIENTE IS NOT NULL THEN 'Jurídico'
        WHEN STG_DB_CLI_FISICA.FL_SEXO_BIOLOGICO = 'M'  THEN 'Masculino'
        WHEN STG_DB_CLI_FISICA.FL_SEXO_BIOLOGICO = 'F'  THEN 'Feminino'
        ELSE 'ERRO CADASTRAL'
    END AS DS_GENERO,

    CAST(STG_DB_CLI_JURIDICA.DT_FUNDACAO AS DATE) AS DT_FUNDACAO,
    STG_DB_CLI_JURIDICA.NR_INSCR_EST,

    CASE 
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('RS', 'PR', 'SC') THEN 'S'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('SP', 'MG', 'RJ', 'ES') THEN 'SE'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('MS', 'MT', 'GO', 'DF') THEN 'CO'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('AC', 'RO', 'RR', 'AM', 'TO', 'PA', 'AP') THEN 'N'
        ELSE 'NE'
    END AS SG_MACRORREGIAO,

    CASE 
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('RS', 'PR', 'SC') THEN 'Sul'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('SP', 'MG', 'RJ', 'ES') THEN 'Sudeste'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('MS', 'MT', 'GO', 'DF') THEN 'Centro-Oeste'
        WHEN STG_DB_ESTADO.SG_ESTADO IN ('AC', 'RO', 'RR', 'AM', 'TO', 'PA', 'AP') THEN 'Norte'
        ELSE 'Nordeste'
    END AS NM_MACRORREGIAO,

    STG_DB_ESTADO.SG_ESTADO,
    STG_DB_ESTADO.NM_ESTADO,
    CAST(STG_DB_CIDADE.CD_CIDADE AS SMALLINT) AS CD_CIDADE,
    STG_DB_CIDADE.NM_CIDADE,
    CAST(STG_DB_BAIRRO.CD_BAIRRO AS INT) AS CD_BAIRRO,
    STG_DB_BAIRRO.NM_BAIRRO,
    CAST(STG_DB_LOGRADOURO.NR_CEP AS INT) AS NR_CEP,

    CAST(
        STG_DB_LOGRADOURO.NM_LOGRADOURO + ', ' +
        CAST(STG_DB_END_CLI.NR_END AS VARCHAR) + ' ' +
        ISNULL(STG_DB_END_CLI.DS_COMPLEMENTO_END, '') 
        AS VARCHAR(120)
    ) + ', ' + STG_DB_CIDADE.NM_CIDADE + '-' + STG_DB_CIDADE.SG_ESTADO AS DS_ENDERECO_COMPLETO,

    STG_DB_END_CLI.DS_COMPLEMENTO_END,
    STG_DB_LOGRADOURO.NM_LOGRADOURO,
    CAST(STG_DB_END_CLI.NR_END AS INT) AS NR_END,

    CASE 
        WHEN STG_DB_END_CLI.ST_END = 'A' THEN 'Ativo'
        WHEN STG_DB_END_CLI.ST_END = 'I' THEN 'Inativo'
        ELSE 'DESCONHECIDO'
    END AS DS_STATUS_END,

    CAST(STG_DB_END_CLI.CD_LOGRADOURO_CLI AS INT) AS CD_LOGRADOURO_CLI,
    CAST(STG_DB_LOGRADOURO.CD_LOGRADOURO AS INT) AS CD_LOGRADOURO,
    STG_DB_BAIRRO.NM_ZONA_BAIRRO,
	STG_DB_CLI_JURIDICA.NR_CNPJ,
	STG_DB_CLI_FISICA.NR_CPF,
	CAST(STG_DB_CIDADE.NR_DDD AS TINYINT) AS NR_DDD,
	CAST(STG_DB_CIDADE.CD_IBGE AS INT) AS CD_IBGE,
	CAST(FORMAT(STG_DB_CLIENTE.QT_ESTRELAS, '00') + ' Estrelas' AS varchar(20)) AS DS_ESTRELAS,

    CAST(STG_DB_END_CLI.DT_INICIO AS DATE) AS DT_INICIO,
    CAST(STG_DB_END_CLI.DT_INICIO AS DATE) AS DT_TERMINO

FROM STG_DB_CLIENTE  
JOIN STG_DB_END_CLI 
    ON STG_DB_CLIENTE.NR_CLIENTE = STG_DB_END_CLI.NR_CLIENTE 
JOIN STG_DB_LOGRADOURO 
    ON STG_DB_LOGRADOURO.CD_LOGRADOURO = STG_DB_END_CLI.CD_LOGRADOURO_CLI
JOIN STG_DB_BAIRRO 
    ON STG_DB_BAIRRO.CD_BAIRRO = STG_DB_LOGRADOURO.CD_BAIRRO
JOIN STG_DB_CIDADE 
    ON STG_DB_BAIRRO.CD_CIDADE = STG_DB_CIDADE.CD_CIDADE
JOIN STG_DB_ESTADO 
    ON STG_DB_ESTADO.SG_ESTADO = STG_DB_CIDADE.SG_ESTADO
LEFT JOIN STG_DB_CLI_FISICA 
    ON STG_DB_CLI_FISICA.NR_CLIENTE = STG_DB_CLIENTE.NR_CLIENTE
LEFT JOIN STG_DB_CLI_JURIDICA 
    ON STG_DB_CLI_JURIDICA.NR_CLIENTE = STG_DB_CLIENTE.NR_CLIENTE
